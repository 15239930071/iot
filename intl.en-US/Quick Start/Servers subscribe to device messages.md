# Servers subscribe to device messages {#task_xy5_wk2_vdb .task}

When devices are connected to IoT Platform, they report data to the platform. Data in the platform can be pushed to your server through a HTTP/2 channel. Set the service subscription through HTTP/2 and configure for HTTP/2 SDKs. You can then connect your server to an HTTP/2 SDK and the server can receive device data.

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17309/15450402108965_en-US.png)

1.  You configure service subscription for your products in the [IoT Platform console](https://partners-intl.console.aliyun.com/#/iot). 

    1.  On the Products page, find the product for which you want to configure the service subscription and click **View**. 
    2.  On the product details page, click **Service Subscription**, and then click **Set**. 
    3.  Select the types of notifications which you want to push to your server \(HTTP/2 SDK\) and click **Save**. 
        -   Device Upstream Notification: Includes the custom data, property data, and event data that are reported by devices, responses to property setting requests, and responses to service callings.
        -   Device Status Change Notification: Indicates the notifications that are sent by the system when the statuses of devices change. For example, the notifications upon devices going online or going offline.
    The subscription configuration in the console takes effect about one minute after the configuration is completed.

2.  Connect to the HTTP/2 SDK. If you use Apache Maven to manage Java projects, you add the following dependency content to the pom.xml file.

    **Note:** Currently, only SDKs in Java 8 are supported.

    ```
    <dependency>
        <groupId>com.aliyun.openservices</groupId>
        <artifactId>iot-client-message</artifactId>
        <version>1.1.3</version>
    </dependency>
    
    <dependency>
        <groupId>com.aliyun</groupId>
        <artifactId>aliyun-java-sdk-core</artifactId>
        <version>3.7.1</version>
    </dependency>
    ```

3.  Connect the SDK and IoT Platform using the AccessKey information of your Alibaba Cloud account for identity authentication. 

    ```
    // Your AccessKey
            String accessKey = "xxxxxxxxxxxxxxx";
            // Your account AccessKeySecret
            String accessSecret = "xxxxxxxxxxxxxxx";
            // Region ID of your IoT Platform service
            String regionId = "cn-shanghai";
            // Your account ID.
            String uid = "xxxxxxxxxxxx";
            // endPoint:  https://${uid}.iot-as-http2.${region}.aliyuncs.com
            String endPoint = "https://" + uid + ".iot-as-http2." + regionId + ".aliyuncs.com";
    
            // Connection configuration
            Profile profile = Profile.getAccessKeyProfile(endPoint, regionId, accessKey, accessSecret);
    
            // Construct the client
            MessageClient client = MessageClientFactory.messageClient(profile);
    
            // Receive data
            client.connect(messageToken -> {
                Message m = messageToken.getMessage();
                System.out.println("receive message from " + m);
                return MessageCallback.Action.CommitSuccess;
            });
    ```

    The parameters are introduced as follows:

    -   accessKey and accessSecret: Log on to the console, move the pointer to your account image, and click **AccessKey**. You are directed to the User Management page and you can create a new AccessKey or view the AccessKey ID and AccessKey Secret of an existing AccessKey on this page.
    -   uid: Log on to the console, move the pointer to your account image, and click **Security Settings**. You are directed to the Account Management page and you can view your account ID on this page.
    -   regionId: The region of your IoT Platform service. For information about RegionId expressions, see [Regions and zones](https://partners-intl.aliyun.com/help/doc-detail/40654.htm).
4.  Test and make sure that the HTTP/2 SDK can successfully receive messages from devices. 

    If the message is successfully received, you can obtain the following data from the message callback of the SDK.

    |Parameter|Description|
    |:--------|:----------|
    |messageId|A 19-bit message ID generated by IoT Platform .|
    |topic|The topic from which the message is sent. For example, `/a1wmrZPO8o9/cbgiotkJ4O4WW59ivysa/data`. If the message is a device status change notification, the topic format is `/as/mqtt/status/${productKey}/${deviceName}`.|
    |payload|     -   The binary data that a Pro Edition device publishes to a topic.
    -   If the message is a device status change notification, the format is as follows:

        ```
{ 
"status":"online" (or offline), //the device status 
"productKey":"xxxxxxxxxxx", //In the above example, the ProductKey is a1wmrZPO8o9 
"deviceName":"xxxxxxxxxx", //In the above example, the DeviceName is cbgiotkJ4O4WW59ivysa 
"time":"2018-08-31 15:32:28.205", //The time when the notification is sent 
"utcTime":"2018-08-31T07:32:28.205Z",//The UTC time when the notification is sent 
"lastTime":"2018-08-31 15:32:28.195", //The time when the last message communication occurred before the status change 
"utcLastTime":"2018-08-31T07:32:28.195Z",//The UTC time when the last message communication occurred before the status change
"clientIp":"xxx.xxx.xxx.xxx" //the Internet IP address of the device. 
}
        ```

**Note:** We recommend that you maintain your device status according to the value of the parameter lastTime.

 |
    |generateTime|The timestamp when the message is generated, in millisecond.|
    |qos|     -   0: The message is only pushed one time.
    -   1: The message is pushed at least one time.
 |


