# Unique-certificate-per-product authentication {#concept_mnt_rwg_12b .concept}

This topic describes the unique-certificate-per-product authentication and how to use this authentication method.

## What is unique-certificate-per-product authentication {#section_mn5_ych_12b .section}

Unique-certificate-per-product authentication requires that devices under a product are installed with the same firmware. A product certificate \(ProductKey and ProductSecret\) is installed on the firmware. Using this authentication method can simplify the installation process. After the firmware has been installed, the device dynamically obtains a DeviceSecret from IoT Platform when it is activated.

**Note:** 

-   Only the device C SDK supports unique-certificate-per-product authentication.
-   Make sure that the device supports unique-certificate-per-product authentication.
-   Unique-certificate-per-product authentication has risks of product certificate leakage because all devices under a product are installed with the same firmware. To resolve this issue, go to Product Information page. Disable Dynamic Register to reject authentication requests from any new devices.

## Workflow of unique-certificate-per-product authentication {#section_jwj_cdh_12b .section}

![](images/6638_en-US.png "Unique-certificate-per-product authentication")

You can use the following process to authenticate a device with unique-certificate-per-product authentication:

1.  Create a product, as shown in "Create products and devices," and obtain the product certificate.
2.  On the Product Information page, enable Dynamic Register. The system will send an SMS to verify your access to IoT Platform.

    **Note:** During verification, the system will reject dynamic activation requests from any new devices if dynamic registration is disabled. Activated devices will not be affected.

3.  On the Devices page, add the device to the product. You can use the MAC address and ID information such as IMEI or SN as DeviceName to pre-register the device with the platform. The device is in Inactive status.

    **Note:** The system verifies the DeviceName to activate a device. We recommend that you use the device ID information that can be read directly from the device as the DeviceName.

4.  Install the same product certificate on all devices under the product, and set `FEATURE_SUPPORT_PRODUCT_SECRET = y` in the device C SDK to enable unique-certificate-per-product authentication.
5.  Power on the device and connect the device to the network. The device sends an authentication request to IoT Platform to perform unique-certificate-per-product authentication. If the device passes authentication, IoT Platform dynamically assigns the corresponding DeviceSecret to the device. The device obtains the ProductKey, DeviceName, and DeviceSecret required for connecting to IoT Platform.

    **Note:** In this method, IoT Platform dynamically assigns a DeviceSecret to the device only for the first activation after the device has been added to IoT Platform. To reactivate a device, delete the device from IoT Platform and add it again.

6.  The device uses the ProductKey, DeviceName, and DeviceSecret to connect to IoT Platform, and publish or subscribe to topics for data upload and download.

## Procedure {#section_kcn_2dh_12b .section}

1.  Use an Alibaba account to log on to [IoT Platform console](http://iot.console.aliyun.com/).
2.  Create a product, as shown in [Create products](intl.en-US/User Guide/Create products and devices.md#).
3.  Obtain the product certificate that is generated by IoT Platform, including ProductKey and ProductSecret.
    1.  Select the product, and click **View** to go to the Product Information page.
    2.  Obtain the product certificate, as shown in the following figure:

        ![](images/6640_en-US.png "Product Information")

    3.  Enable Dynamic Register, and enter the SMS verification code to verify your access to IoT Platform.
4.  On the Devices page, create a device. Use device information such as the MAC address, IMEI, or SN as the DeviceName.
5.  Select a connection protocol, download the device C SDK, and configure the C SDK.
6.  Add the obtained product certificate \(ProductKey and ProductSecret\) to the device SDK.
7.  In the device SDK, set `FEATURE_SUPPORT_PRODUCT_SECRET = y` to enable unique-certificate-per-product authentication.
8.  For more information, see `IOT_CMP_Init` in `/src/cmp/iotx_cmp_api.c`. A code example is as follows:

    ```
    #ifdef SUPPORT_PRODUCT_SECRET
            /* Unique certificate per product */
            if (IOTX_CMP_DEVICE_SECRET_PRODUCT == pparam->secret_type && 0 >= HAL_GetDeviceSecret(device_secret)) {
                HAL_GetProductSecret(product_secret);
                if (strlen(product_secret) == 0) {
                    CMP_ERR(cmp_log_error_secret_1);
                    return FAIL_RETURN;
                }
                /* auth */
                if (FAIL_RETURN == iotx_cmp_auth(product_key, device_name, device_id)) {
                    CMP_ERR(cmp_log_error_auth);
                    return FAIL_RETURN;
                }
            }
        #endif /**< SUPPORT_PRODUCT_SECRET*/
    ```

9.  Perform the following configurations as needed: OTA settings, sub-device connection, device TSL model development, and device shadow management.
10. Install the device SDK that already includes the product certificate on the device.

