# 数据转发到消息服务 {#task_1545804 .task}

您可以使用规则引擎数据流转功能，将设备数据转发到消息服务主题中，服务端再从消息服务主题中订阅消息，实现设备端与服务端之间高性能的消息闭环传输。

## 数据转发流程 {#section_fai_7lz_ylp .section}

-   设备发送数据到服务端。

    设备发布消息到物联网平台中，物联网平台通过规则引擎将消息进行处理并转发到消息服务的主题中。然后，您的应用服务器调用消息服务的接口订阅消息。

    这种方式优势是消息服务可以保证消息的可靠性，避免了服务端不可用时导致消息丢失。同时，消息服务在处理大量消息并发时，有削峰填谷的作用，保证服务端不会因为突然的并发压力导致服务不可用。物联网平台与消息服务的结合，可以实现设备端与服务端之间高性能的消息闭环传输。

-   服务端发送数据到设备。

    您的应用服务器调用物联网平台的云端 API，发布数据到物联网平台中，然后设备从物联网平台中订阅消息。


![设备数据流转](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/7548/15687048904797_zh-CN.png)

## 操作步骤 {#section_3bw_n81_65q .section}

1.  在[访问控制（RAM）控制台](https://ram.console.aliyun.com/)，创建一个授权物联网平台数据写入消息服务的权限角色。 

    物联网平台必须经过您的授权才能对您的消息服务主题写入数据。所以，您需要创建一个具有消息服务写入数据权限的角色，然后将该角色授予给物联网平台。这样规则引擎才能将处理过后的数据写入消息服务中。

    授权相关说明，请参见[管理 RAM 角色](https://www.alibabacloud.com/help/doc-detail/93691.htm)。

2.  在[消息服务控制台](https://mns.console.aliyun.com/)，创建接收消息的主题。 
    1.  在消息服务控制台中，单击**主题** \> **创建主题**。
    2.  在创建主题对话框中，输入主题信息，然后单击**确定**。 

        ![设备数据流转](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/7548/156870489033812_zh-CN.png)

    3.  在主题列表，找到创建的主题，单击其对应的**订阅详情**操作按钮。
    4.  在订阅详情页，单击**创建订阅**。
    5.  为这个主题创建订阅者。消息服务会将接收到的物联网平台的消息发送给您配置的订阅者。 

        **说明：** 目前，物联网平台推送至消息服务主题的消息，仅可以通过队列和HTTP两种方式订阅。

        ![设备数据流转](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/7548/156870489033815_zh-CN.png)

        您可以根据自己的业务需求创建多个订阅者。

        关于消息服务的使用方法，请参见[消息服务产品文档](https://www.alibabacloud.com/help/product/27412.htm)。

3.  在[物联网平台控制台](https://iot.console.aliyun.com/rule/)规则引擎页，单击**创建规则**，创建一个规则。
4.  在规则详情页，为该规则编写用于处理数据的SQL。SQL编写指导，请参见[设置规则引擎](intl.zh-CN/用户指南/规则引擎/数据流转/设置数据流转规则.md#)和[SQL表达式](intl.zh-CN/用户指南/规则引擎/数据流转/SQL表达式.md#)。
5.  在规则详情页，单击**数据转发**栏对应的**添加操作**。
6.  在添加操作对话框中，输入数据转发目标的消息服务主题信息。 

    ![设备数据流转](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/7548/15687048903029_zh-CN.png)

    参数说明：

    |参数|描述|
    |:-|:-|
    |选择操作|选择物联网平台数据转发目标云产品。此处选择为**发送消息到消息服务（Message Service）中**。|
    |地域|选择数据转发目标消息服务主题所在地域。|
    |主题|选择接收数据的消息服务主题。|
    |角色|授予物联网平台访问消息服务的权限角色。物联网平台扮演该角色，便可将数据写入消息服务。|

7.  返回规则引擎页，在数据流转规则列表下，单击该规则对应的**启动**操作按钮，启动规则。 该规则启动后，物联网平台便可将数据转发至设定的主题中，您便可以通过消息服务接收和处理来自物联网平台的数据。

